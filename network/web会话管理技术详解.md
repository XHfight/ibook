# web会话管理(会话跟踪)技术详解  
&emsp;&emsp;会话（Session）跟踪是Web程序中常用的技术，用来跟踪用户的整个会话。常用的会话跟踪技术是Cookie与Session。<font color=Orchid >Cookie通过在客户端记录信息确定用户身份，Session通过在服务器端记录信息确定用户身份。</font>  
* [会话&会话管理(跟踪)](#1)
* [基于Sever端的Session会话管理](#2)
* [基于Client端的Cookie会话管理](#3)
* [Cookie与Session区别](#4)  

参考网站:
http://www.mamicode.com/info-detail-608168.html
https://www.cnblogs.com/lyzg/p/6067766.html
<h2 id="1">会话&会话管理(跟踪)</h2>
- 理解会话:  
一个客户端与服务器之间的通信过程.  
通俗来说:A给B打电话,B接通电话,然后两个人布拉布拉说了一大堆之后挂断了电话,这就是依次会话.如果B没有接通电话,这就不是一次会话.如果A和C通话,这就是另一个会话了.
- 会话的建立与关闭:  
TCP的三次握手就是建立了一次会话,TCP关闭连接就是关闭会话(当会话中的客户端发现自己没有要发送的数据了,就会在数据包头中设置FIN标志,服务端收到后发送包含ACK的确认报文,客户端收到确认报文,通过确认号检查是否已经收到所有数据,当所有数据确认后,客户端关闭和服务端的会话.同理,服务端也是这样关闭和客户端的会话的).    
- __为什么有Web会话跟踪?__

	HTTP协议是一个无状态的协议.  
无状态表现在没有记忆功能,断开了TCP连接，下一次连接与上一次无关.例如:客户端A与服务器进行了一次HTTP通信,过一会,客户端A又给服务器发送请求,这时服务器就不认识它了.
举一个网上购物的例子:A提交了一个HTTP请求,将一个商品加入了购物车,他现在想向购物车中加入第二个商品,发送了HTTP请求后,服务器这时已经不认识他了,不知道要把这个物品加在谁的购物车里面.这时候就会引起混乱.所以我们需要让服务器认识每一个提交属于哪一个用户.  
我们想让服务器能够识别不同的请求是不是来自同一个用户,就要引入会话跟踪机制。 
- 常见的会话跟踪技术  
	* 基于Sever端的session会话管理  
	* 基于Client端的cookie会话管理  
 
	举例说明上面两种情况:超市管理会员的例子  
__session__:发给顾客一张会员卡，除了卡号之外什么信息也不纪录，每次消费时，如果顾客出示该卡片，则店员在店里的纪录本上找到这个卡号对应的纪录添加一些消费信息。这种做法就是在服务器端保持状态.
__cookie__:发给顾客一个记录本，上面记录着消费的历史信息，一般还有个有效期限。每次消费时，如果顾客出示这个记录本，则此次消费就会与以前或以后的消费相联系起来。这种做法就是在客户端保持状态。也就是cookie。 顾客就相当于浏览器.
	
<h2 id="2">基于Sever端的Session会话管理</h2>
__<font color= green >会话信息存储在服务器端</font>__
- <font color = SpringGreen ><b>Session会话管理的过程</b></font>   
	1. 浏览器第一次访问服务器，服务端接收到请求（这里忽略无须会话控制的情况）后,初始化会话(Session)，创建一个Session对象存储会话信息，不同语言实现的应用程序有不同创建Session的方法.
	2. 在创建了session的同时服务器会通过特定的算法为会话(session)生成唯一的会话ID(session id).
	3. 服务器把session ID通过http响应报头setCookie发送给客户端
	4. 客户端接收到这个会话ID，下一次及以后发送请求的时候，附带着这个会话ID一起发送给服务端.  
	5. Session通常会设置失效时间,过了这个时间会被自动删除掉.下次访问需要重新生成session.
	 <b>session id怎么传给服务端呢?</b>
	&emsp;1). 一般情况下,用 Cookie 来实现Session跟踪的，第一次创建Session的时候，服务端会在HTTP协议中告诉客户端，需要在 Cookie 里面记录一个Session ID,以后session id通过 cookie在每次http请求中发送给服务端.
	&emsp; 2). 如果浏览器chookie被禁用,则采用URL重写,将session id加在URL后面,即每次HTTP请求，URL后面都会被附加上一个诸如 sid=xxxxx 这样的参数
	6. 接受到请求之后就会依据Session id找到相应的Session,就知道是谁发送的请求了。这个session ID，就像我们的身份证号码，一直伴随终生,是服务器用来识别用户的标志。

- <font color = SpringGreen ><b>如何存储会话ID(session id)?</b></font>  
__服务端存储__:有多种方式,例如:普通文本存储.文件名就是session id.还可以用memorycache,redies,或者mysql之类的数据库存储,存储的原则是:所有的会话id都是唯一的.  
__客户端存储__:客户端不能像服务器端那样,直接用session id作为文件名,因为一个客户端需要访问多个服务器,多个服务器都会为这个客户端产生一个session id,如果多个服务端采用相同的会话生成算法.则很有可能出现一个客户端收到了来自多个服务端的相同的session id,这个时候,客户端就不认识这是哪个服务端的session id了,所以<font color=VioletRed>本地存储的时候以"域信息"作为文件名(域:一个地方,域名:这个地方的名字,一个域对应一个服务端)</font>    
- __基于服务端Session实现方式的缺陷__  
	1. 这种方式将会话信息存储在web服务器端,所以在用户在线量多的时候,这些会话信息会占用比较多的存储空间.  
	2. 当应用采用集群部署的时候，会遇到多台web服务器之间如何做session共享的问题。因为session是由单个服务器创建的，但是处理用户请求的服务器不一定是那个创建session的服务器，这样他就拿不到之前已经放入到session中的登录凭证之类的信息了；  
__解决方案__:  
采用redis这种中间服务器来管理session的增删改查，一来减轻web服务器的负担，二来解决不同web服务器共享session的问题。

<h2 id="3">基于Client端的Cookie会话管理</h2>  
__<font color=red>会话信息存储在客户端</font>__  
最常见的HTTP客户端--浏览器,使用cookie来存储会话信息(会话信息存储在客户端浏览器),由于Session的方案会增加服务器的负担,所以后来就有人想出直接把会话信息存储在客户端的方案,用户登录后,直接把cookie保存在cookie中,并给cookie设置有效期.  
- __<font color = red >Cookie会话管理的过程</font>__
	1.  用户发起登录请求,服务端跟据输入的用户名,密码等信息来判断用户是否满足条件,如果满足条件,就根据用户信息创建一个cookie发送回浏览器。  
	2. 以后每次http请求都会带上cookie,服务器端接收到浏览器发送的所有cookie之后,通过name来取对应的值(cookie中是使用键值对来存储信息的)。通过这些值来跟踪用户的状态.
	
- __<font color = red >cookie存储信息</font>__:

  1. cookie文件跟据不同的浏览器存储在本地的不同目录下,各个cookie之间是按域来区分的,一个域下存储当前域的cookie信息.
  2.  一个Cookie只能标识一种信息,采用key(name)/value的形式来存储会话信息.name=JSESSIONID(不固定,不同web服务器名字可能不一样), value = XXX,value中存储的就是session id.
  3.  浏览器一般只允许存放300个Cookie，每个站点最多存放20个Cookie，每个Cookie的大小限制为4KB。
  4.  如果创建了一个cookie，并将他发送到浏览器，默认情况下它是一个会话级别的cookie（即存储在浏览器的内存中），用户退出浏览器之后即被删除。若希望浏览器将该cookie存储在磁盘上，则需要使用maxAge，并给出一个以秒为单位的时间。将最大时效设为0则是命令浏览器删除该cookie。  
- __基于服务端Cookie实现方式的缺陷__
    1. cookie有大小限制，存储不了太多的数据
    2. 每次请求需要传送cookie信息,对访问性能会产生影响.
    3. cookie 不安全，可能泄露用户信息。浏览器支持禁用cookie操作。
- __Cookie失效__  
    1. cookie到期自动删除
    2. 手动删除

<h2 id="4" >Session与Cookie的区别</h2>
Session和Cookie有本质的区别  
1.Session是在服务端保存用户信息的一个数据结构，用来跟踪用户的状态，这个数据可以保存在集群、数据库、文件中；  
2.Cookie是客户端保存用户信息的一种机制，用来记录用户的一些信息，也是实现Session的一种方式,利用cookie传递session id。




